{% extends "layout-backoffice-admin.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="container">
    
    <h2>Filterable Table</h2>

    <!-- 필터 입력 필드 -->
    <input type="text" id="filter0" placeholder="이름" style="width: 25%;">
    <input type="text" id="filter1" placeholder="국적"style="width: 25%;">
    <input type="text" id="filter2" placeholder="성별"style="width: 25%;">

    <!-- 테이블 구조 -->
    <table id='filterTable' class="table" style="font-size:13px;">
        <thead>
            <tr>
            <th>이름</th>
            <th>국적</th>
            <th>성별</th>
            <th>기능인 등급</th>
            <th>상세보기</th>
            </tr>
        </thead>
        <tbody>
        </tbody>

    </table>
    

    <!-- 모달 구조 -->
    <div id="myModal" class="modal">
        <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalName"></h2>
        <img id="modalImage" src="" alt="Profile Image" style="width: 150px; height: 150px;">
        
        <div style="height: 450px;">
            <button class="w-btn w-btn-indigo" onclick="toggleSection('career')">경력</button>
            <button class="w-btn w-btn-indigo" onclick="toggleSection('certificate')">자격증</button>
            <button class="w-btn w-btn-indigo" onclick="toggleSection('evaluation')">한줄 평가</button>
            <button class="w-btn w-btn-indigo" onclick="toggleSection('notes')">특이 사항</button>
            <button class="w-btn w-btn-indigo" id="downloadBtn" >다운로드</button>
            <div id="career" class="toggle-content">
                
                <table class="Scroll table" style=" overflow-x: scroll;font-size: 11px;">
                    <thead>
                        <tr>
                            <th>공법</th>
                            <th>현장명</th>
                            <th>기간</th>
                            <th>공수 달성률</th>
                            <th>비고</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>재래식</td>
                            <td>인천광역시 서구 청라동 6-7, 6-8번지(인천경제자유구역 청라국제도시 C18BL)</td>
                            <td>2023.01~2023.11</td>
                            <td>75%</td>
                            <td>계단 작업 가능</td>
                        </tr>
                        <tr>
                            <td>갱폼</td>
                            <td></td>
                            <td></td>
                            <td>60%</td>
                            <td>갱폼 전 과정 작업 가능</td>
                        </tr>
                        <tr>
                            <td>테이블</td>
                            <td></td>
                            <td></td>
                            <td>70%</td>
                            <td>테이블 제작 및 양중</td>
                        </tr>
                        <tr>
                            <td>RCS</td>
                            <td></td>
                            <td></td>
                            <td>60%</td>
                            <td>RCS 설치 보조</td>
                        </tr>
                        <tr>
                            <td>알폼</td>
                            <td></td>
                            <td></td>
                            <td>55%</td>
                            <td>경험 없음</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="certificate" class="toggle-content" style="display: none;">
                <table class="Scroll table" style=" overflow-x: scroll;font-size: 11px;">
                    <thead>
                        <tr>
                            <th>발급날짜</th>
                            <th>종류</th>
                            <th>발급기관</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>20220908</td>
                            <td>거푸집 기능사 국가기술자격증</td>
                            <td>한국산업인력공단</td>
                        </tr>
                        
                    </tbody>
                </table>
            </div>
            <div id="evaluation" class="toggle-content"style="display: none;">
                <div >
                    <h2>리뷰 남기기</h2>
                    <form name="myform" id="myform" class="review-form">
            
                            <fieldset >
                                <label for ='tech-rate' style="color:black;display: inline-block;float:left;padding:0">기술</label>
                                <input type="radio" name="reviewStar1" value="5" id="tech-rate1"><label
                                    for="tech-rate1">★</label>
                                <input type="radio" name="reviewStar1" value="4" id="tech-rate2"><label
                                    for="tech-rate2">★</label>
                                <input type="radio" name="reviewStar1" value="3" id="tech-rate3"><label
                                    for="tech-rate3">★</label>
                                <input type="radio" name="reviewStar1" value="2" id="tech-rate4"><label
                                    for="tech-rate4">★</label>
                                <input type="radio" name="reviewStar1" value="1" id="tech-rate5"><label
                                    for="tech-rate5">★</label>
                            </fieldset>
                       
                            <fieldset >
                                <label for ='quality-rate' style="color:black;display: inline-block;float:left;padding:0">품질</label>
                                <input type="radio" name="reviewStar2" value="5" id="quality-rate1"><label
                                    for="quality-rate1">★</label>
                                <input type="radio" name="reviewSta2" value="4" id="quality-rate2"><label
                                    for="quality-rate2">★</label>
                                <input type="radio" name="reviewStar2" value="3" id="quality-rate3"><label
                                    for="quality-rate3">★</label>
                                <input type="radio" name="reviewStar2" value="2" id="quality-rate4"><label
                                    for="quality-rate4">★</label>
                                <input type="radio" name="reviewStar2" value="1" id="quality-rate5"><label
                                    for="quality-rate5">★</label>
                            </fieldset>
                     
                            <fieldset >
                                <label for ='safety-rate' style="color:black;display: inline-block;float:left;padding:0">안전</label>
                                <input type="radio" name="reviewStar3" value="5" id="safety-rate1"><label
                                    for="safety-rate1">★</label>
                                <input type="radio" name="reviewStar3" value="4" id="safety-rate2"><label
                                    for="safety-rate2">★</label>
                                <input type="radio" name="reviewStar3" value="3" id="safety-rate3"><label
                                    for="safety-rate3">★</label>
                                <input type="radio" name="reviewStar3" value="2" id="safety-rate4"><label
                                    for="safety-rate4">★</label>
                                <input type="radio" name="reviewStar3" value="1" id="safety-rate5"><label
                                    for="safety-rate5">★</label>
                            </fieldset>
                 
                            <fieldset>
                                <label for ='personality-rate' style="color:black;display: inline-block;float:left;padding:0">매너</label>
                                <input type="radio" name="reviewStar4" value="5" id="personality-ㄱate1"><label
                                    for="personality-rate1">★</label>
                                <input type="radio" name="reviewStar4" value="4" id="personality-rate2"><label
                                    for="personality-rate2">★</label>
                                <input type="radio" name="reviewStar4" value="3" id="personality-rate3"><label
                                    for="personality-rate3">★</label>
                                <input type="radio" name="reviewStar4" value="2" id="personality-rate4"><label
                                    for="personality-rate4">★</label>
                                <input type="radio" name="reviewStar4" value="1" id="personality-rate5"><label
                                    for="personality-rate5">★</label>
                            </fieldset>
                 

                        <textarea id="review" rows="4" placeholder="리뷰 내용을 입력하세요" required></textarea>
                        <button type="submit">리뷰 제출</button>
                    </form>
                </div>
            
                <div class="reviews">
                    <details>
                    <summary id = 'reviewhead'></summary>
                    <div id="reviewList">
                        <!-- 리뷰가 여기에 추가됩니다 -->
                    </div>
                   </details>
                </div>
             	
            </div>
            <div id="notes" class="toggle-content"style="display: none;">
                <p>특이사항 없음</p>
            </div>
      
        </div>
        </div>
    </div>
  
</div>
<!-- /.container -->
<script src="static/js/jquery.min.js"></script>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/moment.min.js"></script>
<script src="static/js/fullcalendar.min.js"></script>
<script src="static/js/ko.js"></script>
<script src="static/js/select2.min.js"></script>
<script src="static/js/bootstrap-datetimepicker.min.js"></script>
<script src="static/js/TableFilter.min.js"></script>

<script src="static/js/etcSetting.js"></script>

<script>

// 필터 함수
document.querySelectorAll('input[type="text"]').forEach((input, index) => {
        input.addEventListener('keyup', function () {
            let filterValue = this.value.toLowerCase();
            let table = document.getElementById('filterTable');
            let rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                let cells = rows[i].getElementsByTagName('td');
                let cellText = cells[index].textContent.toLowerCase();

                if (cellText.indexOf(filterValue) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        });
    });

    // 모달 열기 및 상세보기 정보 표시
    function showDetails(button, name, imageSrc) {
        var modal = document.getElementById("myModal");
        var modalName = document.getElementById("modalName");
        var modalImage = document.getElementById("modalImage");
        

        modalName.textContent = name+"("+imageSrc+")";
 
        real_img = "./static/data/개인화폴더/"+imageSrc+"/image.jpg"
        const tableHTML = createDetailsTable(imageSrc);
        document.getElementById('certificate').innerHTML = tableHTML;
        modalImage.src = real_img;
        console.log(imageSrc)
        modal.style.display = "inline-block";
        $.ajax({
            url: '/record-employee',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({'id':imageSrc}),
            success: function (response) {
     
                var data = response['review']; 
                console.log(data)

                // 리뷰 목록에 추가
                var reviewList = document.getElementById('reviewList')
                var reviewhead = document.getElementById('reviewhead')
                reviewList.innerHTML="";
                reviewhead.textContent = `리뷰목록(${data.Comment.length})`
                for (let i = 0; i < data.Comment.length; i++) {
                    const name = data.ID[i];
                    const rating = data.rate[i];
                    let stars = '';
                    for (let j = 0; j < rating; j++) {
                        stars += '⭐'; // 또는 '<span class="star">★</span>'으로 스타일링 가능
                    }
                    const review = data.Comment[i];

                    // 새로운 리뷰 항목 생성
                    const reviewItem = document.createElement('div');
                    reviewItem.classList.add('review');
                    reviewItem.innerHTML = `
                        <h3>${name} 님의 리뷰</h3>
                        <p><strong>별점:</strong> ${stars}</p>
                        <p>${review}</p>
                    `;

                    // 리뷰 목록에 추가
                    reviewList.appendChild(reviewItem);
                }
               
            },
            error: function(error) {
                console.log(error)
               
            }
        });
        
      
      


    }

    // 모달 닫기
    var span = document.getElementsByClassName("close")[0];
    span.onclick = function() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
    }

    function toggleSection(sectionId) {
        // 모든 .toggle-content 섹션을 닫음
        var sections = document.querySelectorAll('.toggle-content');
        sections.forEach(function(section) {
            section.style.display = 'none';
        });

        // 클릭한 섹션만 토글함 (보여주거나 숨김)
        var targetSection = document.getElementById(sectionId);
        if (targetSection.style.display === 'block') {
            targetSection.style.display = 'none';
        } else {
            targetSection.style.display = 'block';
        }
    }

    // 모달을 클릭하면 닫히도록 설정
    window.onclick = function(event) {
        var modal = document.getElementById("myModal");
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    //다운로드 기능 
    document.getElementById('downloadBtn').addEventListener('click', function() {

      const id = document.getElementById('modalName').textContent.split("(")[1].split(")")[0]
      console.log(id)
      // 동적으로 <a> 태그를 만들어 클릭 이벤트를 트리거 (브라우저에 다운로드)
      const a = document.createElement('a');
      // 실제 파일이 위치한 URL (서버에서 /static/data/개인화폴더/A0001 경로로 서빙된다고 가정)
      a.href = "/static/data/개인화폴더/"+id+"/employee_record.xlsx"; 
      // 다운로드될 때 파일명
      a.download = "employee_record.xlsx"; 
      a.click();
    });


    //리뷰 달기 
    document.getElementById('myform').addEventListener('submit', function(event) {
            event.preventDefault();

            // 입력 값 가져오기
            // const name = document.getElementById('name').value;
            // const product = document.getElementById('product').value;
            const name ="전문가1"
            const review = document.getElementById('review').value;
            const rating = document.querySelector('input[name="reviewStar"]:checked') ? document.querySelector('input[name="reviewStar"]:checked').value : '별점 없음';
            console.log(name,review,rating)
            let stars = '';
            for (let j = 0; j < rating; j++) {
                stars += '⭐'; // 또는 '<span class="star">★</span>'으로 스타일링 가능
            }
            // 리뷰 항목 생성
            const reviewItem = document.createElement('div');
            reviewItem.classList.add('review');
            reviewItem.innerHTML = `
                <h3>${name} 님의 리뷰</h3>
                <p><strong>별점:</strong> ${stars}</p>
                <p>${review}</p>
            `;

            // 리뷰 목록에 추가
            document.getElementById('reviewList').appendChild(reviewItem);

            // review rate에도 저장 
            var modalName = document.getElementById("modalName").textContent;
            console.log(modalName)
            var userid = modalName.split("(")[1].split(")")[0]
            console.log(userid)
            saved_data = {'user':userid,"Comment":review,'rate':rating}

            $.ajax({
                url: '/record-save',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(saved_data),
                success: function (response) {
                    console.log(response)
                    alert("데이터가 저장되었습니다.")
                
                },
                error: function(error) {
                    alert('데이터 저장에 실패했습니다.', error);
                }
            });
                

            // 입력 필드 초기화
            document.getElementById('review').value = '';
            const radios = document.querySelectorAll('input[name="rating"]');
            radios.forEach((radio) => (radio.checked = false));
        });


        var info1 = JSON.parse({{info1|tojson|safe}})
        var info2 = JSON.parse({{info2|tojson|safe}})

        function createTable() {
        $("#filterTable tbody").empty();
        let html = `
      
        `;

        // workerData의 각 key(A0001, A0002, ...)별로 순회
        for (let code in info1) {
            const row = info1[code];
            var name = row.성명;
            if(name!==null){
                if(name.includes(" ")){
                name = row.성명.split(" ")[1];
                }
            }
           

            const nation = row.국적;
            const grade = row.등급;
            
            // 성별 정보가 없으므로 임의로 "남자"로 표기 (필요 시 다른 로직 적용)
            const gender = "남자";

            // 각 행을 HTML로 생성
            html += `
            <tr>
                <td>${name}</td>
                <td>${nation}</td>
                <td>${gender}</td>
                <td>${grade}</td>
                <td>
                <button onclick="showDetails(this, '${name}', '${code}')" 
                        class='w-btn w-btn-green'>
                    상세보기
                </button>
                </td>
            </tr>
            `;
        }

        html += `
      
        `;

        // #tableContainer 영역에 삽입
        $("#filterTable tbody").append(html);
        //document.getElementById('filterTable').innerHTML = html;
    }

    /**
     * 상세보기 버튼 눌렀을 때 실행되는 함수 (예시)
     * @param {HTMLElement} btn - 클릭된 버튼 요소
     * @param {string} name - 성명
     * @param {string} code - 코드 (A0001 등)
     */

     const categoryKeyMap = {
    "기초안전": {
      dateKey: "기초안전보건교육 이수증 발급날짜",
      orgKey:  "기초안전보건교육 이수증 발급기관",
      typeKey: "기초안전보건교육 이수증"
    },
    "건설업": {
      dateKey: "건설업 취업인정증 발급날짜",
      orgKey:  "건설업 취업인정증 발급기관",
      typeKey: "건설업 취업인정증"  // 혹은 "건설업 취업인정증 종류"가 있다면 수정
    },
    "국가기술": {
      dateKey: "국가기술자격증 발급날짜",
      orgKey:  "국가기술자격증 발급기관",
      typeKey: "국가기술자격증 종류"
    },
    "기능습득": {
      dateKey: "기능습득 교육 이수증 발급날짜",  // 현재 JSON에 없음
      orgKey:  "기능습득 교육 이수증 발급기관",
      typeKey: "기능습득 교육 이수증" // 또는 "기능습득 교육 종류"
    },
    "지게차": {
      dateKey: "3톤미만지게차 건설기계조종사면허증 발급날짜",
      orgKey:  "3톤미만지게차 건설기계조종사면허증 발급기관",
      typeKey: "3톤미만지게차 건설기계조종사면허증"
    }
  };

  /**
   * 날짜(EpochTime, ms 단위)를 사람이 읽기 좋은 날짜로 변환하는 헬퍼 함수
   */
  function formatDate(ms) {
    if (!ms) return null; // null, undefined 등 처리
    const date = new Date(ms);
    // 예: 'YYYY-MM-DD' 형식
    return date.toLocaleDateString('ko-KR');
  }

  /**
   * 4) 특정 코드(A0001 등)에 대한 상세 테이블을 동적으로 생성하는 함수
   *    (showDetails 함수에서 호출)
   */
  function createDetailsTable(code) {
    // (A) 해당 코드의 데이터 얻기
    const personData = info2[code];
    if (!personData) {
      return `<p>해당 코드를 찾을 수 없습니다: ${code}</p>`;
    }

    // (B) 테이블 시작 태그
    let html = `
      <table class="Scroll table" style=" overflow-x: scroll;font-size: 11px;">
        <thead>
          <tr>
            <th>구분</th>
            <th>발급날짜</th>
            <th>발급기관</th>
            <th>종류</th>
          </tr>
        </thead>
        <tbody>
    `;

    // (C) 5개 카테고리(기초안전, 건설업, 국가기술, 기능습득, 지게차)를 순회
    for (let categoryName in categoryKeyMap) {
      // 예) categoryName = "기초안전"
      //     categoryKeyMap[categoryName] = { dateKey, orgKey, typeKey }
      const { dateKey, orgKey, typeKey } = categoryKeyMap[categoryName];
      
      // 해당 카테고리에 대한 실제 데이터
      const categoryData = personData[categoryName];
      if (!categoryData) {
        // JSON에 해당 카테고리 정보가 없으면 스킵
        continue;
      }

      // (i) 날짜, 기관, 종류 추출
      const dateValue = categoryData[dateKey];
      const orgValue  = categoryData[orgKey];
      const typeValue = categoryData[typeKey];

      // (ii) 발급날짜가 null이거나 없으면 테이블에서 제외
      if (!dateValue) {
        continue;
      }

      // (iii) 날짜 포맷
      const formattedDate = formatDate(dateValue);

      // (iv) null / undefined 대비 (기관, 종류) → 없으면 빈칸 처리
      const orgString  = orgValue  ? orgValue  : "";
      const typeString = typeValue ? typeValue : "";

      // (v) 테이블 한 행 생성
      html += `
        <tr>
          <td>${categoryName}</td>
          <td>${formattedDate}</td>
          <td>${orgString}</td>
          <td>${typeString}</td>
        </tr>
      `;
    }

    // (D) 테이블 닫기
    html += `
        </tbody>
      </table>
    `;

    return html;
  }
     window.onload = createTable;
</script>

{% endblock %}
